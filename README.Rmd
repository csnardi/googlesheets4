---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
can_decrypt <- gargle:::secret_can_decrypt("googlesheets4")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  purl = can_decrypt,
  eval = can_decrypt
)
```

```{r eval = !can_decrypt, echo = FALSE, comment = NA}
message("No token available. Code chunks will not be evaluated.")
```

```{r readme-auth, include = FALSE}
googlesheets4:::sheets_auth_docs()
```

# googlesheets4

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/tidyverse/googlesheets4.svg?branch=master)](https://travis-ci.org/tidyverse/googlesheets4)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/tidyverse/googlesheets4?branch=master&svg=true)](https://ci.appveyor.com/project/tidyverse/googlesheets4)
[![Coverage status](https://codecov.io/gh/tidyverse/googlesheets4/branch/master/graph/badge.svg)](https://codecov.io/github/tidyverse/googlesheets4?branch=master)

googlesheets4 provides an R interface to [Google Sheets](https://spreadsheets.google.com/) via the [Sheets API v4](https://developers.google.com/sheets/api/). It is a reboot of the existing [googlesheets package](https://cran.r-project.org/package=googlesheets).

*Why **4**? Why googlesheets**4**? Did I miss googlesheets1 through 3? No. The idea is to name the package after the corresponding version of the Sheets API. In hindsight, the original googlesheets should have been googlesheets**3**.*

The best source of information is always the package website: <https://googlesheets4.tidyverse.org>

## Installation

You can install the released version of googlesheets4 from [CRAN](https://CRAN.R-project.org) with:

```{r, eval = FALSE}
# NO, NO YOU CANNOT ... BUT SOON!
# install.packages("googlesheets4")
```

And the development version from [GitHub](https://github.com/) with:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("tidyverse/googlesheets4")
```

## Auth

googlesheets4 will, by default, help you interact with Sheets as an authenticated Google user. The package facilitates this process upon first need.

Users can take control of auth proactively via the `sheets_auth*()` family of functions, e.g. to specify your own OAuth app or service account token. Auth is actually handled by the gargle package (<https://gargle.r-lib.org>), similar to googledrive, bigrquery, and gmailr, and gargle's documentation and articles are the definitive guide to more advanced topics.

It is common to use googlesheets4 together with the googledrive package (<https://googledrive.tidyverse.org>). See the article [Using googlesheets4 with googledrive](https://googlesheets4.tidyverse.org/articles/articles/drive-and-sheets.html) for advice on how to streamline auth in this case.

For this overview, we've logged into Google as a specific user in a hidden chunk.

## `read_sheet()`

`read_sheet()` is the main "read" function and should evoke `readr::read_csv()` and `readxl::read_excel()`. It's an alias for `sheets_read()`. Most functions in googlesheets4 actually start with `sheets_`. googlesheets4 is pipe-friendly (and reexports `%>%`), but works just fine without the pipe.

### Identify and access your own Sheet

Let's say you have a cheerful Google Sheet named "deaths". If you want to access it by name, use [googledrive](https://googledrive.tidyverse.org) to identify the document (capture its metadata, especially file id).

<!-- remove the 'message = 4' later -->

```{r message=4}
library(googledrive)
library(googlesheets4)

(deaths <- drive_get("deaths"))
```

Pass the result to googlesheets4 functions such as:

  * `sheets_get()`: gets spreadsheet-specific metadata
  * `read_sheet()`: reads cells into a data frame. `sheets_read()` is an alias for this.

```{r}
sheets_get(deaths)

read_sheet(deaths, range = "A5:F8")
```

If you're willing to refer to the spreadsheet by id (or URL), just provide that directly to googlesheets4 functions and omit googledrive.

```{r}
sheets_get("1ESTf_tH08qzWwFYRC1NVWJjswtLdZn9EGw5e3Z5wMzA")

# a URL also works
sheets_get("https://docs.google.com/spreadsheets/d/1ESTf_tH08qzWwFYRC1NVWJjswtLdZn9EGw5e3Z5wMzA/edit#gid=1210215306")
```

Lesson: googledrive provides the most user-friendly way to refer to files on Google Drive, including files that are Google Sheets. googledrive lets you refer to files by name or path. googlesheets4 is focused on operations specific to Sheets and is more programming oriented. googlesheets4 requires a file id or something that contains the file id, such as the URL or a `dribble` object obtained via googledrive.

### Specify the range and column types

We have a few world-readable Sheets to help with documentation, examples, and general messing around. `sheets_examples()` reveals all of them.

```{r}
library(googlesheets4)

sheets_examples()
```

Once you know the nickname of the example Sheet you want, use `sheets_example()` to get the ID of exactly 1 example file. If you'd like to see it in the browser, use `sheets_browse()`:

```{r eval = FALSE}
sheets_example("deaths") %>% 
  sheets_browse()
```

Here we read from the mini-Gapminder and `deaths` example Sheets to show some of the different ways to specify (work)sheet and cell ranges. Note also that `col_types` gives control of column types, similar to how `col_types` works in readr.

```{r}
read_sheet(sheets_example("mini-gap"), sheet = 2)

read_sheet(sheets_example("mini-gap"), sheet = "Oceania", n_max = 3)

read_sheet(sheets_example("deaths"), skip = 4, n_max = 10)

read_sheet(
  sheets_example("deaths"), range = "other!A5:F15", col_types = "?ci??D"
)
```

If you looked at the `deaths` spreadsheet in the browser, you know that it has some of the typical features of real world spreadsheets: the main data rectangle has prose intended for human-consumption before and after it. That's why we have to specify the range when we read from it.

We've designated the data rectangles as [named ranges](https://support.google.com/docs/answer/63175?co=GENIE.Platform%3DDesktop&hl=en), which provides a very slick way to read them -- definitely less brittle and mysterious than approaches like `range = "other!A5:F15"` or `skip = 4, n_max = 10`. A named range can be passed via the `range =` argument:

```{r}
sheets_example("deaths") %>% 
  read_sheet(range = "arts_data")
```

The named ranges are part of the information returned by `sheets_get()` (although it's currently not revealed by the print method [tidyverse/googlesheets4#41](https://github.com/tidyverse/googlesheets4/issues/41)).

## Roundtripping with a private Sheet

Here is a demo of putting the iris data into a new, private Sheet. Then reading it back into R and exporting as an Excel workbook. Then reading that back into R!

First, put the iris data into a csv file.

```{r}
(iris_tempfile <- tempfile(pattern = "iris-", fileext = ".csv"))
write.csv(iris, iris_tempfile, row.names = FALSE)
```

Use `googledrive::drive_upload()` to upload the csv and simultaneously convert to a Sheet.

```{r}
(iris_ss <- drive_upload(iris_tempfile, type = "spreadsheet"))

## visit the new Sheet in the browser, in an interactive session!
drive_browse(iris_ss)
```

Read data from the private Sheet into R.
```{r}
read_sheet(iris_ss, range = "B1:D6")
```

Download the Sheet as an Excel workbook and read it back in via `readxl::read_excel()`.

```{r}
(iris_xlsxfile <- sub("[.]csv", ".xlsx", iris_tempfile))
drive_download(iris_ss, path = iris_xlsxfile, overwrite = TRUE)

if (requireNamespace("readxl", quietly = TRUE)) {
  readxl::read_excel(iris_xlsxfile)  
}
```

Clean up.

```{r}
file.remove(iris_tempfile, iris_xlsxfile)
drive_rm(iris_ss)
```

## Get Sheet metadata or detailed cell data

`sheets_get()` exposes Sheet metadata. It has a nice print method, but there's much more info in the object itself.

```{r}
(deaths_meta <- sheets_example("deaths") %>% 
   sheets_get())

str(deaths_meta, max.level = 1)

deaths_meta$sheets

deaths_meta$named_ranges
```

`sheets_cells()` returns a data frame with one row per cell and it gives access to raw cell data sent by the Sheets API.

```{r}
(df <- sheets_cells(sheets_example("deaths"), range = "E5:E7"))
df$cell[[3]]
```

`spread_sheet()` converts data in the "one row per cell" form into the data frame you get from `read_sheet()`, which involves reshaping and column typing.

```{r}
df %>% spread_sheet(col_types = "D")
## is same as ...
read_sheet(sheets_example("deaths"), range = "E5:E7", col_types ="D")
```

## What's yet to come?

Writing into Sheets. As shown above, googledrive can already be used to write into Sheets at the "whole file" level, because that is carried out via the Drive API. `googledrive::drive_upload()` and `googledrive::drive_update()` are very useful for this.

But, if you need more granular control, such as writing to specific worksheets or cells, that requires the Sheets API. This is not yet implemented in googlesheets4, but will be.

## Contributing

If you'd like to contribute to the development of googlesheets4, please read [these guidelines](https://googlesheets4.tidyverse.org/CONTRIBUTING.html).

Please note that the 'googlesheets4' project is released with a [Contributor Code of Conduct](https://googlesheets4.tidyverse.org/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.

## Privacy

[Privacy policy](https://www.tidyverse.org/google_privacy_policy)

## Context

googlesheets4 draws on and complements / emulates other packages in the tidyverse:

  * [googlesheets](https://cran.r-project.org/package=googlesheets) is the package that googlesheets4 is replacing. Main improvements in googlesheets4: (1) wraps the current, most modern Sheets API; (2) leans on googledrive for all "whole file" operations; and (3) uses shared infrastructure for auth and more, from the gargle package. Main deficiency: googlesheets4 doesn't _write_ yet.
  * [googledrive](http://googledrive.tidyverse.org) already provides a fully-featured interface to the Google Drive API. Any "whole file" operations can already be accomplished *today* with googledrive: upload or download or update a spreadsheet, copy, rename, move, change permission, delete, etc. googledrive already supports Team Drives.
  * [readxl](http://readxl.tidyverse.org) is the tidyverse package for reading Excel files (xls or xlsx) into an R data frame. googlesheets4 takes cues from parts of the readxl interface, especially around specifying which cells to read.
  * [readr](http://readr.tidyverse.org) is the tidyverse package for reading delimited files (e.g., csv or tsv) into an R data frame. googlesheets4 takes cues from readr with respect to column type specification.
